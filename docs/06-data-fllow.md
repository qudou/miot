# 数据流

这一章节主要综合前面的内容，总结下配件端、外网网关、内网网关以及用户端之间的数据是如果流动的。

本章对于想深入了解平台运转机制的读者，不妨一读。下面分两个方向进行，其中涉及一些网关数据库的内部数据，读者可以自行参阅。

## 配件端到用户端

配件端 <=> 中间件 [=> 用户端]

1. 配件端通过局域网关将 `(pid,topic,data)` 发送给外网网关。

2. 外网网关根据 `part <= pid, link <= client.id` 在表 `apps` 中查出唯一的 `mid` 记录。

3. 若存在中间件，中间件可选择回传数据 `(mid,topic,body)` 给配件端。或者不向用户端发送消息，那么下面几个步骤就没有了。

4. 外网网关在授权表 `auths` 中根据 `mid` 查出已授权的用户 `id` 列表。

5. 外网网关根据 3 中查到的用户列表，在状态表 `status` 中查找在线视图 `(client_id)`。

6. 外网网关将 `(mid,topic,data)` 发送给已查询出的在线视图。

## 用户端到配件端

用户端 <=> 中间件 [=> 配件端]

1. 用户端将 `(mid,topic,body)` 发送给外网网关。

2. 外网网关根据 `mid` 在表 `parts` 中查出唯一的 `mid` 记录。

3. 若存在中间件，中间件可选择回传数据 `(mid,topic,data)` 给用户端。或者不向配件端发送消息，那么下面几个步骤就没有了。

4. 外网网关在记录中提取 `link <= client.id` 和 `part = pid`。

5. 外网网关根据已经查到的 `client.id` 将 `(pid,topic,data)` 发送给局域网关。

6. 局域网关根据 `pid` 将 `(pid,topic,data)` 发送给目标配件。