# 用户端

## 概述

用户端是一个包含若干文件的文件夹，它的名称是已注册好的一个应用标识符。

该文件夹包含一个必需的名为 `index.js` 的主文件。下面是该文件的代码框架，其中顶层命名空间与包含目录名是一致的。组件 `Index` 是会第一个被实例化的入口组件。最后的 `if` 语句是为了满足 `require.js` 规范而添加的。

```js
// 01-01
xmlplus("26cfb15c-1bb5-11e8-accf-0ed5f89f718b", (xp, $_) => {

$_().imports({
    Index: {
        // 入口
    }
});

if ( typeof define === "function" ) {
    define( "xmlplus", [], function () { return xmlplus; } );
}
```

此文件夹还可以包含一个可选的名为 `icon.js` 图标文件，同理，其中顶层命名空间与包含目录名是一致的。前端系统会将其显示为应用图标。如果图标文件未提供，系统则会使用默认图标。下面是一个图标文件的内容：

```js
// 01-02
xmlplus("af5865d0-03c8-11ea-bdae-058d110bb08e", (xp, $_) => {

$_().imports({
    Icon: {
        xml: "<svg viewBox='0 0 1024 1024' width='200' height='200'>\
                <path d='M864.4 831.1V191.7c0-35.3...'/>\
                <path d='M161.1 383.5h703.3v63.9H1...'/>\
              </svg>"
    }
});

});

if ( typeof define === "function" ) {
    define( "xmlplus", [], function () { return xmlplus; } );
}
```

此文件夹中还可以包含图片或者其它资源文件，那么在主文件 `index.js` 该如何对其引用呢？请看下面的示例：

```js
// 01-03
$_().imports({
    Index: {
        xml: "<div id='ip' class='page-content'>\
                <h3>请扫描二维码</h3>\
                <img id='img' src='/parts/af5865d0-03c8-11ea-bdae-058d110bb08e/pic.jpg'/>\
              </div>\
    }
});
```

从上面的代码可见，主文件对相关资源的引用方式为 `/parts/应用的uuid/资源名`。当然也可以在主文件中引用其它应用的资源，但不建议这么做。

## 初始化

作为第一个被实例化的入口组件，当 `Index` 的函数项被执行时，函数的参数 `opts` 包含了两个初始化数据：`name` 和 `data`。其中，`name` 是该应用的名称标识，`data` 是初始化数据。你可以把该函数项理解为面向对象编程语言的类的构造函数。

```js
// 01-04
Index: {
    fun: function (sys, items, opts) {
        // 含 name 和 data 两个选项
        console.log(opts);
    }
}
```

`name` 可以作为标题名置顶。当然，也可以忽略它。`data` 是一个 `PlainObject` 类型的数据，不同的应用可以有不同的 `data` 内容。

## 与中间件或者配件间的数据交互

向中间件或者配件提交数据，不需要明确指出具体的端，这是中间件或者配件的工作。通过触发 `publish` 事件即完成数据的提交。

```js
// 01-05
Index: {
    xml: "<button id='index'>submit</button>",
    fun: function (sys, items, opts) {
        this.on("click", () => {
            this.trigger("publish", ["/payload", {vol: 88}]);
        });
    }
}
```

如上述代码所描述的，提交的数据是一个数组，数组首位是一个用于标识数据主题的字符串。数组的次位是一个 `PlainObject` 类型的对象。

接收中间件或者配件端的数据，不需要特别的方式，只需建立一个侦听目标主题的消息侦听器即可。

```js
// 01-06
Index: {
    xml: "<button id='index'>submit</button>",
    fun: function (sys, items, opts) {
        this.watch("/payload", (e, data) => {
            console.log(data);
        });
    }
}
```

由于用户端与中间件以及配件间的数据交互是建立在 `MQTT` 协议的 `QoS 1` 机制上的，所以在一些应用场合应该注意消息的重入问题。